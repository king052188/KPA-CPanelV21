$(document).ready(function() {
    $.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        }
    });
    
    $("#btnSaveDatabase").click(function (e) {
        e.preventDefault();
        var database = $("#database").val();
        var account =  $("#account").val();
        if(database == "") {
            message_box("Warning!", "Please enter database name.", "warning");
            return false;
        }
        if(parseInt(account) == 0) {
            message_box("Warning!", "Please select username.", "warning");
            return false;
        }
        var db_ = db_prefix + database;
        var data = {database: db_, account: account};
        var d = ajax_execute(data, "/mysql/create-database-execute", "btnSaveDatabase");
        $("#database").val("");
        $("#account").prop('selectedIndex', 0);
    })

    $("#btnSaveAccount").click(function (e) {
        e.preventDefault();
        var host = $("#host").val();
        var username =  $("#username").val();
        var password1 =  $("#password1").val();
        var password2 =  $("#password2").val();
        if(parseInt(host) == 0) {
            message_box("Warning!", "Please select a host.", "warning");
            return false;
        }
        if(username == "") {
            message_box("Warning!", "Please enter username name.", "warning");
            return false;
        }
        if(password1 == "") {
            message_box("Warning!", "Please enter password.", "warning");
            return false;
        }
        if(password2 != password1) {
            message_box("Warning!", "Password did not match.", "warning");
            return false;
        }
        var data = {host: host, username: username, password1: password1};
        var d = ajax_execute(data, "/mysql/create-database-username-execute", "btnSaveAccount");
        $("#username").val("");
        $("#password1").val("");
        $("#password2").val("");
        $("#host").prop('selectedIndex', 0);
    })

    $("#btnSaveAccountPrivileges").click(function (e) {
        e.preventDefault();
        var username =  $("#username").val();
        var database =  $("#database").val();
        if(parseInt(username) == 0) {
            message_box("Warning!", "Please select a username.", "warning");
            return false;
        }
        if(parseInt(database) == 0) {
            message_box("Warning!", "Please select a database.", "warning");
            return false;
        }
        var usernames = username.split(":");
        if(usernames.lenght < 2) {
            message_box("Warning!", "Please select a database.", "warning");
            return false;
        }
        var role =  usernames[0];
        username =  usernames[1];
        var data = {role: role, username: username, database: database};
        var d = ajax_execute(data, "/mysql/add-privileges-execute", "btnSaveAccountPrivileges");
        $("#username").prop('selectedIndex', 0);
        $("#database").prop('selectedIndex', 0);
    })
})

function ajax_execute(data, url, button_id) {
    $(document).ready(function() {
        $.ajax({
            dataType: 'json',
            type:'POST',
            url: url,
            data: data,
            beforeSend: function () {
                $("#"+button_id).text("Please wait....");
            }
        }).done(function(data){

            console.log(data);

            if(data.code == 200) {
                message_box("Hooray!", data.message, "success");
            }
            else if (data.code == 500) {
                message_box("Oops, Something went wrong.", data.message, "success");
            }
            else {
                message_box("Warning!", data.message, "warning");
            }
            $("#"+button_id).text("Save");
        });
    })
}

function message_box(title, message, type) {
    toastr.options.closeMethod = 'fadeOut';
    toastr.options.closeDuration = 3000;
    toastr.options.closeEasing = 'swing';
    toastr.options.closeButton = true;
    toastr.options.closeHtml = '<button><i class="icon-off"></i></button>';
    toastr.options.progressBar = true;
    switch (type) {
        case "success" :
            toastr.success(message, title);
            break;

        case "warning" :
            toastr.warning(message, title);
            break;

        default :
            toastr.error(message, title);
            break;
    }
}
