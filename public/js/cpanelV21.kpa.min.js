$(document).ready(function() {
    $.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        }
    });

    $("#btnCreateServer").click(function (e) {
        e.preventDefault();
        var package_ =  $("#package_id").val();
        var region_ =  $("#region_id").val();
        var password =  $("#password").val();
        var password2 =  $("#password2").val();

        if(password.length < 6 || password.length > 10) {
            message_box("Warning!", "Minimum password length 6 to 10 max.", "warning");
            return false;
        }

        if(password != password2) {
            message_box("Warning!", "Password did not match.", "warning");
            return false;
        }

        if(parseInt(package_) == 0) {
            message_box("Warning!", "Please choose one of our packages", "warning");
            return false;
        }

        if(parseInt(region_) == 0) {
            message_box("Warning!", "Please choose one of our data centers", "warning");
            return false;
        }

        var data = { package : package_, region : region_, password : password };

        console.log(data);

        var d = ajax_execute(data, "/api/package/plan/create", "btnCreateServer", "YES");
    })

    $("#btnWebSite").click(function (e) {
        e.preventDefault();
        var host =  $("#host").val();
        var domain =  $("#domain").val();
        var hostname =  $("#hostname").val();
        var port =  $("#port").val();
        var protocol =  $("#protocol").val();
        var host_domain = null;
        var host_port = 80;

        if(parseInt(host) == 0) {
            message_box("Warning!", "Please select a host.", "warning");
            return false;
        }

        if(port != "") {
            host_port = parseInt(port);
            if(host_port < 8000) {
                message_box("Warning!", "Oops, port range is from 8000 to 9999.", "warning");
                return false;
            }
            if(host_port > 9999) {
                message_box("Warning!", "Oops, port range is from 8000 to 9999.", "warning");
                return false;
            }
        }

        if(parseInt(host) == 1) {
            if(domain == "") {
                message_box("Warning!", "Please enter your domain.", "warning");
                return false;
            }
            host_domain = domain;
        }
        else {
            host_domain = hostname + "." + host;
        }
        var data = { hostname: host_domain, port: host_port, protocol: protocol };
        var d = ajax_execute(data, "/api/web/create", "btnWebSite", null);
    })
    
    $("#btnSaveDatabase").click(function (e) {
        e.preventDefault();
        var database = $("#database").val();
        var account =  $("#account").val();
        if(database == "") {
            message_box("Warning!", "Please enter database name.", "warning");
            return false;
        }
        if(parseInt(account) == 0) {
            message_box("Warning!", "Please select username.", "warning");
            return false;
        }
        var db_ = db_prefix + database;
        var data = {database: db_, account: account};
        var d = ajax_execute(data, "/mysql/create-database-execute", "btnSaveDatabase", null);
        $("#database").val("");
        $("#account").prop('selectedIndex', 0);
    })

    $("#btnSaveAccount").click(function (e) {
        e.preventDefault();
        var host = $("#host").val();
        var username =  $("#username").val();
        var password1 =  $("#password1").val();
        var password2 =  $("#password2").val();
        if(parseInt(host) == 0) {
            message_box("Warning!", "Please select a host.", "warning");
            return false;
        }
        if(username == "") {
            message_box("Warning!", "Please enter username name.", "warning");
            return false;
        }
        if(password1 == "") {
            message_box("Warning!", "Please enter password.", "warning");
            return false;
        }
        if(password2 != password1) {
            message_box("Warning!", "Password did not match.", "warning");
            return false;
        }
        var data = {host: host, username: username, password1: password1};
        var d = ajax_execute(data, "/mysql/create-database-username-execute", "btnSaveAccount", null);
        $("#username").val("");
        $("#password1").val("");
        $("#password2").val("");
        $("#host").prop('selectedIndex', 0);
    })

    $("#btnSaveAccountPrivileges").click(function (e) {
        e.preventDefault();
        var username =  $("#username").val();
        var database =  $("#database").val();
        if(parseInt(username) == 0) {
            message_box("Warning!", "Please select a username.", "warning");
            return false;
        }
        if(parseInt(database) == 0) {
            message_box("Warning!", "Please select a database.", "warning");
            return false;
        }
        var usernames = username.split(":");
        if(usernames.lenght < 2) {
            message_box("Warning!", "Please select a database.", "warning");
            return false;
        }
        var role =  usernames[0];
        username =  usernames[1];
        var data = {role: role, username: username, database: database};
        var d = ajax_execute(data, "/mysql/add-privileges-execute", "btnSaveAccountPrivileges", null);
        $("#username").prop('selectedIndex', 0);
        $("#database").prop('selectedIndex', 0);
    })

    $("#btnApproveShareDatabase").click(function (e) {
        e.preventDefault();
        if(s_uid == 0) {
            message_box("Warning!", "Username details did not recognized.", "warning");
            return false;
        }
        if(u_role == 0) {
            message_box("Warning!", "Please reload your page.", "warning");
            return false;
        }
        if(u_name == null) {
            message_box("Warning!", "Please enter the username.", "warning");
            return false;
        }
        if(d_name == null) {
            message_box("Warning!", "Please select a database.", "warning");
            return false;
        }
        var data = {shared_uid: s_uid, role: u_role, username: u_name};
        var d = ajax_execute(data, "/mysql/share/database/" + d_name, "btnApproveShareDatabase", null);
    })

    $("#btnSaveDisk").click(function (e) {
        e.preventDefault();
        var username =  $("#account").val();
        var app =  $("#app").val();
        var quota =  $("#quota").val();

        if(username == "") {
            message_box("Warning!", "Username is missing.", "warning");
            return false;
        }

        var data = { account: username, size: quota};
        var d = ajax_execute(data, "/api/disk/create", "btnSaveDisk");
    })

    $("#btnSaveFTP").click(function (e) {
        e.preventDefault();
        var username =  $("#username").val();
        var password1 =  $("#password1").val();
        var password2 =  $("#password2").val();

        if(app_name == "") {
            message_box("Warning!", "Please set the applicantion name.", "warning");
            return false;
        }
        if(username == "") {
            message_box("Warning!", "Please set the username.", "warning");
            return false;
        }
        if(password1 == "") {
            message_box("Warning!", "Please enter password.", "warning");
            return false;
        }
        if(password2 != password1) {
            message_box("Warning!", "Password did not match.", "warning");
            return false;
        }

        var data = { account: root_path, app: app_name, sub: sub_name, username: username, password: password1 };
        var d = ajax_execute(data, "/api/ftp/create", "btnSaveFTP", null);
    })

    $( "#btnStateYes" ).click(function(e) {
        e.preventDefault();

        var data = { domain: state_hostname, status: state_status };

        ajax_execute_2(data, "/api/web/site/state");
    })
})
function ajax_execute_2(data, url) {
    $(document).ready(function() {
        $.ajax({
            dataType: 'json',
            type:'POST',
            url: url,
            data: data,
            beforeSend: function () {
                $("#state_loader_fb").removeAttr("style");
                $("#state_loader_fb").attr("style", "-webkit-transform:scale(0.22);");
                $("#btnStateYes").text("Please wait...");
            }
        }).done(function(data){
            if(data.Code == 200) {
                $("#state_loader_fb").removeAttr("style");
                $("#state_loader_fb").attr("style", "display: none;");
                $("#btnStateYes").text("Yes").hide();
                $("#btnStateNo").text("Close");
                var s = "was STOPPED successfully";
                if(status == 1) {
                    s = "was RESTARTED successfully";
                }
                $('#state_msg').empty().prepend("<h5 class='text-center' style='line-height: 20px;'><span style='color: #E91E63;'>( " + state_hostname + " )</span> "+s+"</h5>");
                reload_sites();
            }
            else {
                $("#state_loader_fb").removeAttr("style");
                $("#state_loader_fb").attr("style", "display: none;");
                $("#btnStateYes").text("Yes");

                $('#state_msg').empty().prepend("<h5 class='text-center' style='line-height: 20px;'><span style='color: #E91E63;'>( " + state_hostname + " )</span><br />Oops"+data.Message+"</h5>");
            }
            console.log(data);
        });
    })
}

function ajax_execute(data, url, button_id, redirect) {
    $(document).ready(function() {
        $.ajax({
            dataType: 'json',
            type:'POST',
            url: url,
            data: data,
            beforeSend: function () {
                $("#"+button_id).text("Please wait....");
            }
        }).done(function(data){
            console.log(data);

            if(data.code == 200) {
                if(redirect != null) {
                    window.location.href=data.url;
                    return false;
                }
                message_box("Hooray!", data.message, "success");
            }
            else if (data.code == 500) {
                message_box("Oops, Something went wrong.", data.message, "success");
            }
            else {
                message_box("Warning!", data.message, "warning");
            }
            $("#"+button_id).hide();
        });
    })
}

function message_box(title, message, type) {
    toastr.options.closeMethod = 'fadeOut';
    toastr.options.closeDuration = 2000;
    toastr.options.closeEasing = 'swing';
    toastr.options.closeButton = true;
    toastr.options.closeHtml = '<button><i class="icon-off"></i></button>';
    toastr.options.progressBar = true;
    switch (type) {
        case "success" :
            toastr.success(message, title);
            break;

        case "warning" :
            toastr.warning(message, title);
            break;

        default :
            toastr.error(message, title);
            break;
    }

    setInterval(reload, 2001);
}

function reload() {
    location.reload();
}
